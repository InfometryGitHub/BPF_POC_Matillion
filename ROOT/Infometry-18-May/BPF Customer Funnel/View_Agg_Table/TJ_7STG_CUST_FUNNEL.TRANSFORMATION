{"job":{"components":{"58529":{"id":58529,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":193,"y":93,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[58717],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL 0"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select * from  \"BPF_DATAMART\".\"PUBLIC\".\"VW_7STG_CUST_FUNNEL\"\n/*\nwith conv_funnel_raw as (\nselect \nL.LEAD_EMAIL AS contact_email\n,l.LEAD_SCORE as tier\n,l.PIPELINE  AS deal_pipeline\n--,convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz) as current_dttm\n--,date_trunc('day',current_dttm) as today_date\n,date_trunc('day',convert_timezone('US/Pacific', getdate())) as today_date\n,l.PITCH_SCHEDULED_DT_KEY\n,l.LEAD_SQL_CREATED_DT_KEY\n,l.SALES_LEAD_MQL_DT_KEY\n,l.TOUR_SCHEDULED_DT_KEY\n,l.CONTRACT_SIGNED_DT_KEY\n\n,BPF_DATAMART.\"PUBLIC\".NUMBER_TO_DATE(TO_CHAR(PITCH_SCHEDULED_DT_KEY))AS PITCH_SCHEDULED_DT\n,BPF_DATAMART.\"PUBLIC\".NUMBER_TO_DATE(TO_CHAR(l.SALES_LEAD_MQL_DT_KEY))AS sales_lead_mql_timestamp_dt\n,BPF_DATAMART.\"PUBLIC\".NUMBER_TO_DATE(TO_CHAR(l.TOUR_SCHEDULED_DT_KEY))AS tour_scheduled_dt\n,BPF_DATAMART.\"PUBLIC\".NUMBER_TO_DATE(TO_CHAR(l.TOUR_SCHEDULED_DT_KEY))AS CONTRACT_SIGNED_DT\n\n,date_trunc('day',PITCH_SCHEDULED_DT) as pitch_scheduled_day\n\n--,date_trunc('day',sales_lead_mql_timestamp) as sales_lead_day\n,date_trunc('day',sales_lead_mql_timestamp_dt) as sales_lead_day\n\n--,cast(datediff('day', sales_lead_mql_timestamp, pitch_scheduled) as float) as lead_to_pitch_days\n,cast(datediff('day', sales_lead_mql_timestamp_dt, PITCH_SCHEDULED_DT) as float) as lead_to_pitch_days\n\n--,date_trunc('day',tour_scheduled) as tour_scheduled_day\n,date_trunc('day',tour_scheduled_dt) as tour_scheduled_day\n\n--,cast(datediff('day', pitch_scheduled, tour_scheduled) as float) as pitch_to_tour_days\n,cast(datediff('day', PITCH_SCHEDULED_DT, tour_scheduled_dt) as float) as pitch_to_tour_days\n\n--,date_trunc('day',contract_signed) as contract_signed_day\n,date_trunc('day',CONTRACT_SIGNED_DT) as contract_signed_day\n\n--,cast(datediff('day', tour_scheduled, contract_signed) as float) as tour_to_contract_days\n,cast(datediff('day', tour_scheduled_dt, CONTRACT_SIGNED_DT) as float) as tour_to_contract_days\n\n--,cast(datediff('day', sales_lead_mql_timestamp, contract_signed) as float) as lead_to_contract_days\n,cast(datediff('day', sales_lead_mql_timestamp_dt, CONTRACT_SIGNED_DT) as float) as lead_to_contract_days\n\n--,datediff('day', pitch_scheduled, today_date) as pitch_to_now_days\n,datediff('day', PITCH_SCHEDULED_DT, today_date) as pitch_to_now_days\n\n--datediff('day', sales_lead_mql_timestamp,today_date) as lead_to_now_days\n,datediff('day', sales_lead_mql_timestamp_dt,today_date) as lead_to_now_days\n\n--,cast(datediff('day', tour_scheduled, today_date) as float) as tour_to_now_days\n,cast(datediff('day', tour_scheduled_dt, today_date) as float) as tour_to_now_days\n\nfrom \n--{{ @Customer_Funnel }}\nBPF_DATAMART.\"PUBLIC\".FACT_LEAD L\n),\n\nleads as (\nselect\ndeal_pipeline,\nsales_lead_day,\ncount(*) as leads\n--convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz) as current_dttm,\nfrom conv_funnel_raw\nwhere \nsales_lead_day between date_trunc('year',dateadd('year',-1,convert_timezone('US/Pacific',getdate()))) and convert_timezone('US/Pacific',getdate())\n--sales_lead_day between date_trunc('year',dateadd('year',-1,convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz))) and convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz)\ngroup by 1,2\n)\n--SELECT * FROM leads\n,\n\npitches_scheduled as (\nselect\ndeal_pipeline,\npitch_scheduled_day,\ncount(*) as pitches\n--convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz)\nfrom conv_funnel_raw\nwhere \npitch_scheduled_day between date_trunc('year',dateadd('year',-1,convert_timezone('US/Pacific',getdate()))) and convert_timezone('US/Pacific',getdate())\n--pitch_scheduled_day between date_trunc('year',dateadd('year',-1,convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz))) and convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz)\ngroup by 1,2\n),\n\ntours_scheduled as (\nselect\ndeal_pipeline,\ntour_scheduled_day,\ncount(*) as tours\n--convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz)\nfrom conv_funnel_raw\nwhere \ntour_scheduled_day between date_trunc('year',dateadd('year',-1,convert_timezone('US/Pacific',getdate()))) and convert_timezone('US/Pacific',getdate())\n--tour_scheduled_day between date_trunc('year',dateadd('year',-1,convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz))) and convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz)\ngroup by 1,2\n),\n\ncontracts_signed as (\nselect\ndeal_pipeline,\ncontract_signed_day,\ncount(*) as contracts_signed\n--convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz)\nfrom conv_funnel_raw\nwhere \ncontract_signed_day between date_trunc('year',dateadd('year',-1,convert_timezone('US/Pacific',getdate()))) and convert_timezone('US/Pacific',getdate())\n--contract_signed_day between date_trunc('year',dateadd('year',-1,convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz))) and convert_timezone('UTC','America/Los_Angeles',getdate()::timestamp_ntz)\ngroup by 1,2\n),\n\ncombined_funnel as (\nselect \ncoalesce(l.sales_lead_day,p.pitch_scheduled_day,t.tour_scheduled_day,c.contract_signed_day) as day,\ncoalesce(l.deal_pipeline,p.deal_pipeline,t.deal_pipeline,c.deal_pipeline) as deal_pipeline,\nsum(l.leads) as leads,\nsum(p.pitches) as pitches,\nsum(t.tours) as tours,\nsum(c.contracts_signed) as contracts_signed\nfrom leads l\nfull outer join pitches_scheduled p on pitch_scheduled_day = sales_lead_day and l.deal_pipeline = p.deal_pipeline\nfull outer join tours_scheduled t on tour_scheduled_day = coalesce(l.sales_lead_day, p.pitch_scheduled_day) and coalesce(l.deal_pipeline,p.deal_pipeline) = t.deal_pipeline\nfull outer join contracts_signed c on contract_signed_day = coalesce(l.sales_lead_day, p.pitch_scheduled_day,t.tour_scheduled_day) and coalesce(l.deal_pipeline,p.deal_pipeline,t.deal_pipeline) = c.deal_pipeline\ngroup by 1,2\n)\n--SELECT * FROM combined_funnel\n,\n\ncombined_funnel_stages as (\nselect \ndate_trunc('month', day) as month,\nday,\ndeal_pipeline,\nsum(leads) over (partition by month, deal_pipeline order by day asc ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as leads_mtd,\nsum(pitches) over (partition by month, deal_pipeline order by day asc ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pitches_mtd,\nsum(tours) over (partition by month, deal_pipeline order by day asc ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as tours_mtd,\nsum(contracts_signed) over (partition by month, deal_pipeline order by day asc ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as contracts_signed\nfrom combined_funnel\nwhere day is not null\n)\n--SELECT * FROM combined_funnel_stages\n,\n\ncalendar AS (\nselect \n--calendar_date, date_trunc('month',c.calendar_date) as calendar_month \nc.FULLDATE AS calendar_date, \ndate_trunc('month',c.FULLDATE) as calendar_month\nfrom \n--{{ @Calendar as c }}\nBPF_DATAMART.\"PUBLIC\".DIM_CALENDAR c\njoin (select max(month) as max_month from combined_funnel_stages) ON\nmax_month = date_trunc('month',c.FULLDATE)\n)\n\nselect \nCOALESCE(c.calendar_month,funnel.month) as month,\nCOALESCE(c.calendar_date,funnel.day) as day,\nfunnel.deal_pipeline,\ncase when deal_pipeline = 'CA' then 'California'\nwhen deal_pipeline = 'Other' then 'Flagstaff'\nelse null end as forest_group,\nfunnel.leads_mtd,\nfunnel.pitches_mtd,\nfunnel.tours_mtd,\nfunnel.contracts_signed\n--,cast(datepart(day,COALESCE(c.calendar_date,funnel.day)) as decimal) / cast(datepart(day,dateadd(day,-1,dateadd(month,1,COALESCE(c.calendar_month,funnel.month)))) as decimal) as month_pct\n,cast(date_part(day,COALESCE(c.calendar_date,funnel.day)) as decimal) / cast(date_part(day,dateadd(day,-1,dateadd(month,1,COALESCE(c.calendar_month,funnel.month)))) as decimal) as month_pct\n\n,case when forest_group != 'California' then null when tgt.count_first_scheduled_call is null then 584 else tgt.count_first_scheduled_call end * month_pct as count_first_scheduled_call_target\n,case when forest_group != 'California' then null when tgt.count_scheduled_tours is null then 158 else tgt.count_scheduled_tours end * month_pct as count_scheduled_tours_target\n,case when forest_group != 'California' then null when tgt.count_signed_contracts is null then 70 else tgt.count_signed_contracts end * month_pct as count_signed_contracts_target\nfrom combined_funnel_stages funnel\nfull join calendar c ON\nfunnel.day = c.calendar_date\nleft outer join \n--facts.targets_monthly tgt on \nBPF_LANDING.\"PUBLIC\".FACTS_TARGETS_MONTHLY tgt on\nCOALESCE(c.calendar_month,funnel.month) = TO_DATE(TO_CHAR(tgt.\"month\"),'DD-MM-YYYY')\nwhere (forest_group = 'California' \nor (forest_group = 'Flagstaff' and day >= '2019-11-01'))\n--AND leads_mtd IS NOT null\norder by LEADS_MTD,1,2\n\n--SELECT TO_DATE(TO_CHAR(MONTH),'DD-MM-YYYY')MNTH FROM BPF_LANDING.\"PUBLIC\".FACTS_TARGETS_MONTHLY tgt\n\n*/"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"58716":{"id":58716,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":335239555,"x":319,"y":112,"width":32,"height":32,"inputConnectorIDs":[58717],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Rewrite Table 0"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Agg_7STG_CUST_FUNNEL"}}}},"visible":true},"6":{"slot":6,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"BPF_DATAMART"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"PUBLIC"}}}},"visible":true},"8":{"slot":8,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"BPF_SMALL"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"58717":{"id":58717,"sourceID":58529,"targetID":58716}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"TJ_7STG_CUST_FUNNEL","description":"","type":"TRANSFORMATION","tag":"fba7a757-9114-427b-9dee-06465adc7e18"}}